<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Cuti</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{font-family:system-ui;background:#f1f5f9;margin:0}
.container{max-width:1800px;margin:auto;padding:20px}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{padding:10px;border-bottom:1px solid #ddd;font-size:14px}
thead{background:#1e40af;color:#fff}
input,select,button{padding:6px;border-radius:6px}
.gen{background:#16a34a;color:#fff}
.view{background:#2563eb;color:#fff}
.hapus{background:#dc2626;color:#fff}
</style>
</head>

<body>
<div class="container">
<h2>ADMIN CUTI</h2>
<table>
<thead>
<tr>
<th>No</th><th>Nama</th><th>Mulai</th><th>Lama</th>
<th>Cuti Bersama</th><th>Tgl Selesai</th>
<th>Nomor Surat</th><th>Status</th><th>Aksi</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://ufiqibxdgwlysqhinqbz.supabase.co",
  "sb_publishable_EVSVWnsUriOPA_O3RnGTpg_Zmd4pyAL"
);

const GAS_URL = "PASTE_URL_WEB_APP_GAS_ANDA";
const GAS_TOKEN = "SECRET_TOKEN_RSDS";

const tbody = document.getElementById("tbody");
const fmt = d=>d?new Date(d).toLocaleDateString("id-ID"):"";

async function load(){
  const {data} = await supabase.from("pengajuan_cuti")
    .select("*").order("created_at",{ascending:false});
  tbody.innerHTML="";
  data.forEach((d,i)=>{
    tbody.innerHTML+=`
<tr>
<td>${i+1}</td>
<td>${d.nama}</td>
<td>${fmt(d.tgl_mulai)}</td>
<td>${d.lama_cuti}</td>

<td><input type="number" value="${d.cuti_bersama||0}"
 onblur="updateCuti('${d.id}',this.value)"></td>

<td><input type="date" value="${d.tgl_selesai||""}"
 onblur="updateSelesai('${d.id}',this.value)"></td>

<td><input value="${d.nomor_surat||""}"
 onblur="updateNomor('${d.id}',this.value)"></td>

<td>
<select onchange="updateStatus('${d.id}',this.value)">
<option ${d.status=="DIAJUKAN"?"selected":""}>DIAJUKAN</option>
<option ${d.status=="DISETUJUI"?"selected":""}>DISETUJUI</option>
<option ${d.status=="DITOLAK"?"selected":""}>DITOLAK</option>
</select>
</td>

<td>
${d.doc_url
? `<button class="view" onclick="window.open('${d.doc_url}')">LIHAT</button>`
: `<button class="gen" onclick='buat(${JSON.stringify(d)})'>BUAT</button>`}
<button class="hapus" onclick="hapus('${d.id}')">HAPUS</button>
</td>
</tr>`;
  });
}

window.updateCuti=(id,v)=>supabase.from("pengajuan_cuti")
.update({cuti_bersama:parseInt(v||0)}).eq("id",id);

window.updateSelesai=(id,v)=>supabase.from("pengajuan_cuti")
.update({tgl_selesai:v||null}).eq("id",id);

window.updateNomor=(id,v)=>supabase.from("pengajuan_cuti")
.update({nomor_surat:v||null}).eq("id",id);

window.updateStatus=(id,v)=>supabase.from("pengajuan_cuti")
.update({status:v}).eq("id",id);

window.hapus=async(id)=>{
 if(confirm("Hapus?")){
  await supabase.from("pengajuan_cuti").delete().eq("id",id);
  load();
 }
};

window.buat=async(row)=>{
 const res=await fetch(GAS_URL,{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
    token:GAS_TOKEN,
    nama:row.nama,
    nip:row.nip,
    jabatan:row.jabatan,
    jenis_cuti:row.jenis_cuti,
    awal_cuti:row.tgl_mulai,
    lama_cuti:row.lama_cuti,
    cuti_bersama:row.cuti_bersama||0,
    alamat:row.alamat,
    sisa_cuti:row.sisa_cuti,
    nomor_surat:row.nomor_surat,
    ttd_url:row.signature_url
  })
 });
 const j=await res.json();
 await supabase.from("pengajuan_cuti")
 .update({doc_url:j.doc_url,tgl_selesai:j.tgl_selesai})
 .eq("id",row.id);
 load();
};

load();
</script>
</body>
</html>
