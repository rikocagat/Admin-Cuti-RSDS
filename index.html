<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Cuti</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.container{max-width:1500px;margin:auto;padding:20px}
h2{text-align:center}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;font-size:13px}
thead{background:#1e40af;color:#fff}
select,button{padding:6px 10px;border-radius:8px;font-weight:700}
button{background:#dc2626;color:#fff;border:none;cursor:pointer}
button:hover{opacity:.85}
.status-DIAJUKAN{background:#fde68a}
.status-DISETUJUI{background:#bbf7d0}
.status-DITOLAK{background:#fecaca}
</style>
</head>

<body>
<div class="container">
<h2>üõ†Ô∏è ADMIN CUTI</h2>

<table>
<thead>
<tr>
<th>No</th>
<th>Nama</th>
<th>NIP</th>
<th>Jenis</th>
<th>Lama</th>
<th>File 1</th>
<th>File 2</th>
<th>TTD</th>
<th>Status</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://ufiqibxdgwlysqhinqbz.supabase.co",
  "SERVICE_ROLE_KEY_ANDA" // ‚ö†Ô∏è ADMIN ONLY
);

const BUCKET = "NAMA_BUCKET_ANDA";
const tbody = document.getElementById("tbody");

function getPath(url){
  if(!url) return null;
  return url.split("/object/public/")[1];
}

async function load(){
  const { data } = await supabase
    .from("pengajuan_cuti")
    .select("*")
    .order("created_at",{ascending:false});

  tbody.innerHTML="";
  data.forEach((d,i)=>{
    tbody.innerHTML += `
    <tr>
      <td>${i+1}</td>
      <td>${d.nama}</td>
      <td>${d.nip}</td>
      <td>${d.jenis_cuti}</td>
      <td>${d.lama_cuti} hari</td>
      <td>${d.file_1_url ? `<a href="${d.file_1_url}" target="_blank">Lihat</a>`:"-"}</td>
      <td>${d.file_2_url ? `<a href="${d.file_2_url}" target="_blank">Lihat</a>`:"-"}</td>
      <td>${d.signature_url ? `<a href="${d.signature_url}" target="_blank">Lihat</a>`:"-"}</td>
      <td>
        <select class="status-${d.status}"
          onchange="updateStatus('${d.id}',this.value,this)">
          <option>DIAJUKAN</option>
          <option>DISETUJUI</option>
          <option>DITOLAK</option>
        </select>
      </td>
      <td>
        <button onclick="hapus('${d.id}','${d.file_1_url}','${d.file_2_url}','${d.signature_url}')">
          HAPUS
        </button>
      </td>
    </tr>`;
  });
}

async function updateStatus(id,val,el){
  await supabase.from("pengajuan_cuti")
    .update({status:val}).eq("id",id);
  el.className="status-"+val;
}

async function hapus(id,f1,f2,ttd){
  if(!confirm("Hapus DATA & FILE PERMANEN?")) return;

  const files = [f1,f2,ttd].map(getPath).filter(Boolean);

  if(files.length){
    await supabase.storage.from(BUCKET).remove(files);
  }

  await supabase.from("pengajuan_cuti").delete().eq("id",id);
  load();
}

load();
</script>
</body>
</html>
